<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SGIP Eligibility & Incentive Calculator</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+fHnn3Lpsp8fYfN39h779iH0L4K6R9O8A8V+4Co+0=" crossorigin=""/>
  <style>
    /* Colors based on SGIP pamphlet */
    :root {
      --gold: #F2C94C;
      --navy: #003C71;
      --bright: #FDB813;
      --bg: #FFFFFF;
      --text: #333333;
      --muted: #555555;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
    }
    header { background: var(--navy); color: white; padding: 1rem; text-align: center; }
    header h1 { margin: 0; font-size: 1.8rem; }
    .layout { display: flex; flex-wrap: wrap; }
    .sidebar, .content { padding: 1rem; }
    .sidebar { flex: 1 1 300px; background: var(--bright); color: var(--navy); }
    .content { flex: 2 1 600px; }
    .zone-map { height: 300px; border: 2px solid var(--navy); border-radius: 4px; margin-bottom: 1rem; }
    form { background: #f9f9f9; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    form .field { margin-bottom: 1rem; }
    form label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    form input, form select, form button {
      width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;
    }
    form button { background: var(--gold); color: var(--navy); border: none; cursor: pointer; font-weight: bold; margin-top: 0.5rem; }
    form button:hover { background: var(--bright); }
    .result { margin-top: 1rem; background: var(--bg); border-left: 4px solid var(--gold); padding: 0.75rem; border-radius: 4px; }
    .result h2 { margin-top: 0; color: var(--navy); }
    @media (max-width: 768px) { .layout { flex-direction: column; } header h1 { font-size: 1.4rem; } }
  </style>
</head>
<body>
  <header><h1>SGIP Eligibility & Incentive Calculator</h1></header>
  <div class="layout">
    <aside class="sidebar">
      <h2>Enter Your Information</h2>
      <form id="calcForm">
        <div class="field"><label for="zip">ZIP Code</label><input type="text" id="zip" placeholder="e.g., 90210" /></div>
        <div id="zoneMap" class="zone-map"></div>
        <div class="field"><label for="customerType">Host Customer Class</label><select id="customerType"><option value="">Select type</option><option value="residential-single">Residential Single-Family</option><option value="residential-multi">Residential Multifamily</option><option value="commercial">Commercial/Business</option><option value="industrial">Industrial/Agricultural</option></select></div>
        <div class="field"><label for="inDAC">Disadvantaged Community?</label><select id="inDAC"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div class="field"><label for="inFire">TierÂ 2/3 Wildfire Threat Zone?</label><select id="inFire"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div class="field"><label for="inPSPS">PSPS Shutoff Area?</label><select id="inPSPS"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div class="field"><label for="capacity">Storage Capacity (kWh)</label><input type="number" id="capacity" min="0" placeholder="e.g., 30" /></div>
        <div class="field"><label for="solarCapacity">Solar PV Capacity (kW)</label><input type="number" id="solarCapacity" min="0" step="0.1" placeholder="e.g., 5" /></div>
        <div class="field"><button type="button" id="btnCheck">Calculate Incentive</button></div>
      </form>
    </aside>
    <section class="content"><div id="result" class="result" style="display:none;"></div></section>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.3/dist/esri-leaflet.js"></script>
  <script>
    // Rates
    const rates = { general:0.25, smallRes:0.15, equity:1.10, resiliency:1.00, sjv:1.10, solar:3.10, generation:2.00 };
    // Init map & layers
    const map = L.map('zoneMap').setView([37.7749,-122.4194],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let userMarker;
    const dacLayer = L.esri.featureLayer({url:'https://services.arcgis.com/jIL9msH9KiTzpLmm/ArcGIS/rest/services/CE_Boundaries_SB535/FeatureServer/0'}).addTo(map);
    const fireLayer = L.esri.featureLayer({url:'https://services.arcgis.com/T4QMspbfLg3qTGWY/ArcGIS/rest/services/CPUC_Fire_HFDT_2_3/FeatureServer/0'}).addTo(map);
    async function geocode(zip){const r=await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&SingleLine=${zip}`);const j=await r.json();if(j.candidates?.length)return j.candidates[0].location;throw'ZIP not found';}
    document.getElementById('zip').addEventListener('blur',async()=>{
      try{
        const loc=await geocode(document.getElementById('zip').value);
        const latlng=[loc.y,loc.x];map.setView(latlng,12);
        userMarker?userMarker.setLatLng(latlng):(userMarker=L.marker(latlng).addTo(map));
        const dac=await new Promise(r=>dacLayer.query().intersects(L.latLng(latlng)).run((e,f)=>r(!e&&f.features.length>0)));
        const fire=await new Promise(r=>fireLayer.query().intersects(L.latLng(latlng)).run((e,f)=>r(!e&&f.features.length>0)));
        document.getElementById('inDAC').value=dac?'yes':'no';
        document.getElementById('inFire').value=fire?'yes':'no';
      }catch(e){console.error(e);}
    });
    document.getElementById('btnCheck').addEventListener('click',()=>{
      const cap=parseFloat(document.getElementById('capacity').value)||0;
      const sol=parseFloat(document.getElementById('solarCapacity').value)||0;
      const breakdown=[];
      breakdown.push(`General Market: $${(cap*1000*rates.general).toLocaleString()}`);
      breakdown.push(`Small Res.: $${(cap*1000*rates.smallRes).toLocaleString()}`);
      breakdown.push(`Equity: $${(cap*1000*rates.equity).toLocaleString()}`);
      breakdown.push(`Resiliency: $${(cap*1000*rates.resiliency).toLocaleString()}`);
      breakdown.push(`SJV: $${(cap*1000*rates.sjv).toLocaleString()}`);
      breakdown.push(`Solar AB209: $${(sol*1000*rates.solar).toLocaleString()}`);
      breakdown.push(`Generation: $${(sol*1000*rates.generation).toLocaleString()}`);
      document.getElementById('result').style.display='block';
      document.getElementById('result').innerHTML='<h2>Incentive Breakdown</h2><ul>'+breakdown.map(l=>`<li>${l}</li>`).join('')+'</ul>';
    });
  </script>
</body>
</html>

