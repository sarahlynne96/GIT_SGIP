<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SGIP Eligibility & Incentive Calculator</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+fHnn3Lpsp8fYfN39h779iH0L4K6R9O8A8V+4Co+0=" crossorigin=""/>
  <style>
    :root {
      --primary: #fdb813;
      --secondary: #003c71;
      --accent: #005eb8;
      --bg: #f9f9f9;
      --text: #333;
      --muted: #555;
    }
    body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family:Arial,sans-serif; }
    h1 { color:var(--primary); text-align:center; margin:20px 0; font-size:1.8rem; }
    .container { display:flex; flex-wrap:wrap; max-width:1200px; margin:0 auto; padding:10px; gap:20px; }
    .maps, .calculator { flex:1 1 100%; }
    @media (min-width:768px) { .maps{flex:1 1 60%;} .calculator{flex:1 1 38%;} }
    .map-container { border:1px solid var(--accent); border-radius:4px; overflow:hidden; margin-bottom:20px; }
    .map-container h2 { margin:0; padding:10px; background:var(--secondary); color:#fff; font-size:1rem; }
    .map-container iframe, #zoneMap { width:100%; height:400px; border:0; }
    form>div { margin-bottom:15px; }
    label { display:block; font-weight:bold; color:var(--secondary); margin-bottom:5px; font-size:1rem; }
    select,input { width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; font-size:1rem; }
    button { background:var(--primary); color:#fff; border:none; padding:12px 20px; font-size:1rem; border-radius:4px; cursor:pointer; transition:background 0.3s; }
    button:hover { background:var(--accent); }
    .result { margin-top:20px; padding:15px; background:#fff; border-left:5px solid var(--primary); border-radius:4px; font-size:1rem; line-height:1.4; }
    small { color:var(--muted); font-size:0.875rem; }
    @media (max-width:767px) {
      .container{flex-direction:column;padding:5px;gap:10px;}
      h1{font-size:1.5rem;margin:10px 0;}
      .map-container iframe,#zoneMap{height:250px;}
      .map-container h2{font-size:0.9rem;padding:8px;}
      label{font-size:0.9rem;}
      select,input{font-size:0.95rem;padding:8px;}
      button{width:100%;font-size:1rem;padding:12px;}
    }
  </style>
</head>
<body>
  <h1>SGIP Eligibility & Incentive Calculator</h1>
  <div class="container">
    <div class="maps">
      <div class="map-container"><h2>SBÂ 535 Disadvantaged Communities Map</h2><iframe src="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities/" title="DAC Map"></iframe></div>
      <div class="map-container"><h2>Community Air Protection (CAP UC) Map</h2><iframe src="https://capuc.maps.arcgis.com/apps/webappviewer/index.html?id=5bdb921d747a46929d9f00dbdb6d0fa2" title="CAP UC Map"></iframe></div>
      <div class="map-container"><h2>SCE Shutoff (Outage Status) Tool</h2><p style="padding:10px;"><a href="https://www.sce.com/outages-safety/outage-center/check-outage-status" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:bold;">ðŸ”— Check Public Safety Shutoff Status</a></p></div>
    </div>
    <div class="calculator">
      <form id="calcForm">
        <div><label for="zip">ZIP Code</label><input type="text" id="zip" placeholder="e.g., 90210"><small>Enter ZIP to detect zones & map.</small></div>
        <div id="zoneMap" style="width:100%;height:300px;margin-bottom:15px;"></div>
        <div><label for="customerType">Host Customer Class</label><select id="customerType"><option value="">Select type</option><option value="residential-single">Single-Family</option><option value="residential-multi">Multifamily</option><option value="commercial">Commercial</option><option value="industrial">Industrial</option></select></div>
        <div><label for="inDAC">Disadvantaged Community?</label><select id="inDAC"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="inFire">TierÂ 2/3 Wildfire Threat Zone?</label><select id="inFire"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="inPSPS">PSPS Shutoff Area?</label><select id="inPSPS"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="equityPathway1">Multifamily Equity Pathway</label><select id="equityPathway1"><option value=""></option><option value="deed">Deed-restricted low-income (â‰¥5 units)</option><option value="80pct">â‰¥80% â‰¤60% AMI</option><option value="mash">Reserved MASH/SOMAH</option></select></div>
        <div><label for="singleEquity">Single-Family Equity Criterion</label><select id="singleEquity"><option value=""></option><option value="income">Income verified per HUD</option><option value="program">SASH/DAC-SASH/CARE/FERA/ESA</option></select></div>
        <div><label for="care">CARE Participation?</label><select id="care"><option value=""></option><option value="yes">Yes</option><option value="no">No</option><option value="unsure">Unsure</option></select></div>
        <div><label for="helpEnroll">Help enrolling in CARE?</label><select id="helpEnroll"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="capacity">Storage Capacity (kWh)</label><input type="number" id="capacity" min="0" placeholder="e.g., 30"></div>
        <div><label for="solarCapacity">Solar PV Capacity (kW)</label><input type="number" id="solarCapacity" min="0" step="0.1" placeholder="e.g., 5"></div>
        <div><label for="backup">Backup Capability?</label><select id="backup"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><button type="button" id="btnCheck">Calculate Eligibility & Incentive</button></div>
      </form>
      <div id="result" class="result" style="display:none;"></div>
    </div>
  </div>
  <!-- Leaflet JS & Esri Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7kQf4qd2dMkWx1hC2pY65TrbH+Cr3Z7l+oPKU8=" crossorigin=""></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.3/dist/esri-leaflet.js"></script>
  <script>
    // Rates
    const generalStorageRate=0.25, smallResidentialRate=0.15, equityRatepayerRate=1.10,
      equityResiliencyRate=1.00, sjvRate=1.10, solarAB209Rate=3.10, generationBaseRate=2.00;
    // Map vars
    let zoneMap, userMarker, dacLayer, fireLayer;
    const dacService='https://services.arcgis.com/jIL9msH9KiTzpLmm/ArcGIS/rest/services/CE_Boundaries_SB535/FeatureServer/0';
    const fireService='https://services.arcgis.com/T4QMspbfLg3qTGWY/ArcGIS/rest/services/CPUC_Fire_HFDT_2_3/FeatureServer/0';
    // Geocode
    async function geocode(zip){
      const r=await fetch(`https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?SingleLine=${zip}&f=pjson`);
      const js=await r.json(); if(js.candidates&&js.candidates.length) return js.candidates[0].location;
      throw'Invalid ZIP';
    }
    // Init or update map
    function updateMap(lat,lon){
      if(!zoneMap){
        zoneMap=L.map('zoneMap').setView([lat,lon],12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(zoneMap);
        dacLayer=L.esri.featureLayer({url:dacService}).addTo(zoneMap);
        fireLayer=L.esri.featureLayer({url:fireService}).addTo(zoneMap);
        userMarker=L.marker([lat,lon]).addTo(zoneMap);
      } else {
        zoneMap.setView([lat,lon],12);
        userMarker.setLatLng([lat,lon]);
      }
    }
    // Event: ZIP blur
    document.getElementById('zip').addEventListener('blur',async()=>{
      const zip=document.getElementById('zip').value;
      try{
        const {y:lat,x:lon}=await geocode(zip);
        document.getElementById('inDAC').value=await dacLayer.query().intersects(L.point(lon,lat)).run().then(f=>f.features.length>0)?'yes':'no';
        document.getElementById('inFire').value=await fireLayer.query().intersects(L.point(lon,lat)).run().then(f=>f.features.length>0)?'yes':'no';
        updateMap(lat,lon);
      }catch(e){console.warn(e);}    });
    // Calculate breakdown
    document.getElementById('btnCheck').addEventListener('click',()=>{
      const cust=document.getElementById('customerType').value;
      const care=document.getElementById('care').value==='yes',
            helpEnroll=document.getElementById('helpEnroll').value==='yes',
            capacity=parseFloat(document.getElementById('capacity').value)||0,
            solarCap=parseFloat(document.getElementById('solarCapacity').value)||0;
      const gen=capacity*1000*generalStorageRate,
            smallRes=capacity*1000*smallResidentialRate,
            eq=capacity*1000*equityRatepayerRate,
            eqRes=capacity*1000*equityResiliencyRate,
            sjv=capacity*1000*sjvRate,
            solarAB=solarCap*1000*solarAB209Rate,
            solarGen=solarCap*1000*generationBaseRate;
      const lines=[];
      lines.push(`General Market Storage: $${gen.toLocaleString()} (${capacity}â€¯kWh Ã— $${generalStorageRate}/Wh)`);
      lines.push(`Small Residential Storage: $${smallRes.toLocaleString()} (${capacity}â€¯kWh Ã— $${smallResidentialRate}/Wh)`);
      if(cust.startsWith('residential')){
        lines.push(`Residential Equity Storage: $${eq.toLocaleString()} (${capacity}â€¯kWh Ã— $${equityRatepayerRate}/Wh)`);
        lines.push(`Equity Resiliency Storage: $${eqRes.toLocaleString()} (${capacity}â€¯kWh Ã— $${equityResiliencyRate}/Wh)`);
        lines.push(`San Joaquin Valley Storage: $${sjv.toLocaleString()} (${capacity}â€¯kWh Ã— $${sjvRate}/Wh)`);
      }
      if(solarCap>0){
        lines.push(`Solar ABÂ 209 Incentive: $${solarAB.toLocaleString()} (${solarCap}â€¯kW Ã— $${solarAB209Rate}/W)`);
        lines.push(`Generation Base Incentive: $${solarGen.toLocaleString()} (${solarCap}â€¯kW Ã— $${generationBaseRate}/W)`);
      }
      if(care) lines.push(`CARE Discount: 20% bill savings${helpEnroll?' (assistance available)':''}.`);
      document.getElementById('result').innerHTML='<h2>Incentive Breakdown</h2><ul>'+lines.map(l=>`<li>${l}</li>`).join('')+'</ul>';
      document.getElementById('result').style.display='block';
    });
  </script>
</body>
</html>
